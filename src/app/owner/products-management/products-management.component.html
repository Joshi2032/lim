<div class="products-management">
  <app-page-header
    title="GestiÃ³n de Productos"
    japaneseName="è£½å“ç®¡ç†"
    [action]="pageAction"
    (actionClick)="toggleForm()">
  </app-page-header>

  <app-tabs-container
    [tabs]="tabs"
    [activeTab]="activeType"
    [onTabChange]="onTabChange">
  </app-tabs-container>

  <div class="products-list">
    @if (activeType === 'platos') {
      @if (menuItems.length > 0) {
        @for (item of menuItems; track item.id) {
          <app-product-card
            [product]="item"
            badgeType="popular"
            (edit)="editItem($any($event))"
            (delete)="deleteItem($event)">
          </app-product-card>
        }
      } @else {
        <app-empty-state
          icon="search"
          title="No hay platos registrados"
          description="Comienza agregando un nuevo plato al menÃº">
        </app-empty-state>
      }
    }

    @if (activeType === 'combos') {
      @if (combos.length > 0) {
        @for (combo of combos; track combo.id) {
          <app-product-card
            [product]="combo"
            badgeType="oferta"
            (edit)="editCombo($any($event))"
            (delete)="deleteCombo($event)">
          </app-product-card>
        }
      } @else {
        <app-empty-state
          icon="cart"
          title="No hay combos registrados"
          description="Crea combos para ofrecer ofertas especiales">
        </app-empty-state>
      }
    }
  </div>
</div>

<!-- Product Form Modal -->
<app-modal
  [isOpen]="showForm"
  [title]="(isEditing ? 'Editar' : 'Nuevo') + ' ' + (activeType === 'platos' ? 'Plato' : 'Combo')"
  [showFooter]="false"
  (close)="toggleForm()">
  @if (activeType === 'platos') {
    <div class="form">
          <div class="form-group">
            <label class="form-label">Nombre del plato *</label>
            <input
              type="text"
              [(ngModel)]="newItem.name"
              (ngModelChange)="onItemNameChange()"
              placeholder="Ej: Sushi Roll California"
              class="form-input"
              maxlength="50">
            <span class="input-counter">{{ newItem.name.length }}/50</span>
            @if (newItem.japaneseName) {
              <span class="japanese-preview">{{ newItem.japaneseName }}</span>
            }
          </div>

          <div class="form-group">
            <label class="form-label">Foto del plato</label>
            <div class="image-upload-wrapper">
              @if (itemImagePreview) {
                <div class="image-preview">
                  <img [src]="itemImagePreview" alt="Preview">
                  <button type="button" class="change-btn" (click)="itemFileInput.click()">Cambiar</button>
                </div>
              } @else {
                <label class="upload-area" (click)="itemFileInput.click()">
                  <div class="upload-icon">ðŸ“¸</div>
                  <div class="upload-text">Selecciona una foto</div>
                </label>
              }
              <input
                #itemFileInput
                type="file"
                accept="image/*"
                (change)="onItemImageSelected($event)"
                class="hidden-input">
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">DescripciÃ³n *</label>
            <textarea
              [(ngModel)]="newItem.description"
              placeholder="Describe los ingredientes y caracterÃ­sticas del plato"
              class="form-input form-textarea"
              rows="3"
              maxlength="200"></textarea>
            <span class="input-counter">{{ newItem.description.length }}/200</span>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">CategorÃ­a *</label>
              <select [(ngModel)]="newItem.category" class="form-input">
                @for (cat of categories; track cat.id) {
                  <option [ngValue]="cat.id">{{ cat.icon }} {{ cat.name }}</option>
                }
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Precio *</label>
              <div class="price-input-wrapper">
                <span class="currency">$</span>
                <input
                  type="number"
                  [(ngModel)]="newItem.price"
                  placeholder="0.00"
                  class="form-input price-input"
                  min="0"
                  step="0.01">
              </div>
            </div>
          </div>

          <button class="btn-submit" (click)="addItem()">
            <span>âœ“</span> {{ isEditing ? 'Actualizar' : 'Guardar' }} Plato
          </button>
        </div>
      }

      @if (activeType === 'combos') {
        <div class="form">
          <div class="form-group">
            <label class="form-label">Nombre del combo *</label>
            <input
              type="text"
              [(ngModel)]="newCombo.name"
              (change)="onComboNameChange()"
              placeholder="Ej: Combo Familiar"
              class="form-input"
              maxlength="50">
            <span class="input-counter">{{ newCombo.name.length }}/50</span>
            @if (newCombo.japaneseName) {
              <span class="japanese-preview">{{ newCombo.japaneseName }}</span>
            }
          </div>
          <div class="form-group">
            <label class="form-label">Foto del combo</label>
            <div class="image-upload-wrapper">
              @if (comboImagePreview) {
                <div class="image-preview">
                  <img [src]="comboImagePreview" alt="Preview">
                  <button type="button" class="change-btn" (click)="comboFileInput.click()">Cambiar</button>
                </div>
              } @else {
                <label class="upload-area" (click)="comboFileInput.click()">
                  <div class="upload-icon">ðŸ“¸</div>
                  <div class="upload-text">Selecciona una foto</div>
                </label>
              }
              <input
                #comboFileInput
                type="file"
                accept="image/*"
                (change)="onComboImageSelected($event)"
                class="hidden-input">
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Selecciona platillos *</label>
            <div class="combo-items-list">
              @for (item of menuItems; track item.id) {
                <div class="combo-item">
                  <label class="combo-item-label">
                    <input
                      type="checkbox"
                      [checked]="selectedComboItems[item.id] || false"
                      (change)="toggleComboItem(item.id)"
                      class="combo-checkbox">
                    <div class="combo-item-info">
                      <div class="combo-item-name">{{ item.name }}</div>
                      <div class="combo-item-price">${{ item.price }}</div>
                    </div>
                  </label>
                </div>
              }
              @if (menuItems.length === 0) {
                <div class="empty-items">No hay platillos disponibles</div>
              }
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">DescripciÃ³n (opcional)</label>
            <textarea
              [(ngModel)]="newCombo.description"
              placeholder="Describe quÃ© incluye el combo"
              class="form-input form-textarea"
              rows="2"
              maxlength="200"></textarea>
            <span class="input-counter">{{ newCombo.description.length }}/200</span>
          </div>

          <div class="form-group">
            <label class="form-label">Precio *</label>
            <div class="price-input-wrapper">
              <span class="currency">$</span>
              <input
                type="number"
                [(ngModel)]="newCombo.price"
                placeholder="0.00"
                class="form-input price-input"
                min="0"
                step="0.01">
            </div>
            @if (getSelectedComboPrice() > 0) {
              <div class="combo-price-info">
                <div class="price-breakdown">
                  <span class="original-price">Total items: ${{ getSelectedComboPrice() }}</span>
                  <span class="discount-badge">Precio personalizado</span>
                </div>
              </div>
            }
          </div>

          <button class="btn-submit" (click)="addItem()">
            <span>âœ“</span> {{ isEditing ? 'Actualizar' : 'Guardar' }} Combo
          </button>
        </div>
      }
</app-modal>
