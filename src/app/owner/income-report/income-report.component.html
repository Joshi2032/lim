<div class="income-container" [class.embedded]="embedded">
  @if (!embedded) {
    <app-sidebar
      [menuItems]="sidebarItems"
      [currentUser]="currentUser"
      [cartCount]="cartCount">
    </app-sidebar>
  }

  <div class="income-content">
    <app-page-header
      title="Reportes de Ingresos"
      japaneseName="収入報告"
      subtitle="Análisis detallado de ingresos por período">
    </app-page-header>

    <!-- Filters Section -->
    <app-income-filters
      [periodType]="periodType"
      [orderType]="orderType"
      [startDate]="startDate"
      [endDate]="endDate"
      [searchQuery]="searchQuery"
      (periodTypeChange)="periodType = $event; onPeriodTypeChange()"
      (orderTypeChange)="orderType = $event; onOrderTypeChange()"
      (dateChange)="onDateChange()"
      (search)="onSearch()"
      (export)="exportToCSV()">
    </app-income-filters>

    <!-- Stats Cards -->
    <div class="stats-grid">
      @for (card of statCards; track card.title) {
        <app-stat-card
          [title]="card.title"
          [value]="card.value"
          [iconSvg]="card.iconSvg"
          [variant]="card.variant">
        </app-stat-card>
      }
    </div>

    <!-- Period Summary Chart -->
    <div class="chart-card">
      <app-section-header [title]="'Ingresos por ' + (periodType === 'day' ? 'Día' : periodType === 'month' ? 'Mes' : 'Año')"></app-section-header>

      <div class="chart-container">
        @if (periodSummaries.length > 0) {
          <div class="bar-chart">
            @for (summary of periodSummaries; track summary.period) {
              <div class="bar-item">
                <div class="bar-wrapper">
                  <div
                    class="bar-fill"
                    [style.height.%]="summary.percentage"
                    [title]="formatCurrency(summary.total)">
                  </div>
                </div>
                <div class="bar-info">
                  <div class="bar-period">{{ summary.period }}</div>
                  <div class="bar-value">{{ formatCurrency(summary.total) }}</div>
                  <div class="bar-orders">{{ summary.orders }} órdenes</div>
                </div>
              </div>
            }
          </div>
        } @else {
          <app-empty-state
            icon="inbox"
            title="No hay datos para mostrar"
            subtitle="Ajusta los filtros para ver resultados">
          </app-empty-state>
        }
      </div>
    </div>

    <!-- Detailed Table -->
    <app-income-table [records]="filteredRecords"></app-income-table>
  </div>
</div>
