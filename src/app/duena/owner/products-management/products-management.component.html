<div class="products-management">
  <app-page-header
    title="Gesti√≥n de Productos"
    japaneseName="Ë£ΩÂìÅÁÆ°ÁêÜ"
    [action]="pageAction"
    (actionClick)="toggleForm()">
  </app-page-header>

  <app-tabs-container
    [tabs]="tabs"
    [activeTab]="activeType"
    [onTabChange]="onTabChange">
  </app-tabs-container>

  <div class="products-list">
    @if (activeType === 'platos') {
      @if (menuItems.length > 0) {
        @for (item of menuItems; track item.id) {
          <div class="product-card">
            <div class="product-header">
              <div class="product-info">
                <h3>{{ item.name }}</h3>
                @if (item.japaneseName) {
                  <p class="japanese">{{ item.japaneseName }}</p>
                }
              </div>
              <div class="product-price">${{ item.price }}</div>
            </div>
            <p class="product-description">{{ item.description }}</p>
            <div class="product-category">
              <app-badge [text]="item.category" type="popular"></app-badge>
            </div>
            <div class="product-actions">
              <button class="btn-edit" (click)="editItem(item)">Editar</button>
              <button class="btn-delete" (click)="deleteItem(item.id)">Eliminar</button>
            </div>
          </div>
        }
      } @else {
        <app-empty-state
          icon="search"
          title="No hay platos registrados"
          description="Comienza agregando un nuevo plato al men√∫">
        </app-empty-state>
      }
    }

    @if (activeType === 'combos') {
      @if (combos.length > 0) {
        @for (combo of combos; track combo.id) {
          <div class="product-card">
            <div class="product-header">
              <div class="product-info">
                <h3>{{ combo.name }}</h3>
                @if (combo.japaneseName) {
                  <p class="japanese">{{ combo.japaneseName }}</p>
                }
              </div>
              <div class="product-price">${{ combo.price }}</div>
            </div>
            <p class="product-description">{{ combo.description }}</p>
            <div class="product-category">
              <app-badge [text]="combo.category || 'combo'" type="oferta"></app-badge>
            </div>
            <div class="product-actions">
              <button class="btn-edit" (click)="editCombo(combo)">Editar</button>
              <button class="btn-delete" (click)="deleteCombo(combo.id)">Eliminar</button>
            </div>
          </div>
        }
      } @else {
        <app-empty-state
          icon="cart"
          title="No hay combos registrados"
          description="Crea combos para ofrecer ofertas especiales">
        </app-empty-state>
      }
    }
  </div>
</div>

<!-- Product Form Modal -->
<div class="modal-overlay" *ngIf="showForm" (click)="toggleForm()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ isEditing ? 'Editar' : 'Nuevo' }} {{ activeType === 'platos' ? 'Plato' : 'Combo' }}</h2>
      <button type="button" class="close-btn" (click)="toggleForm()" aria-label="Cerrar">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>

    <div class="modal-body">
      @if (activeType === 'platos') {
        <div class="form">
          <div class="form-group">
            <label class="form-label">Nombre del plato *</label>
            <input
              type="text"
              [(ngModel)]="newItem.name"
              (ngModelChange)="onItemNameChange()"
              placeholder="Ej: Sushi Roll California"
              class="form-input"
              maxlength="50">
            <span class="input-counter">{{ newItem.name.length }}/50</span>
            @if (newItem.japaneseName) {
              <span class="japanese-preview">{{ newItem.japaneseName }}</span>
            }
          </div>

          <div class="form-group">
            <label class="form-label">Foto del plato</label>
            <div class="image-upload-wrapper">
              @if (itemImagePreview) {
                <div class="image-preview">
                  <img [src]="itemImagePreview" alt="Preview">
                  <button type="button" class="change-btn" (click)="itemFileInput.click()">Cambiar</button>
                </div>
              } @else {
                <label class="upload-area" (click)="itemFileInput.click()">
                  <div class="upload-icon">üì∏</div>
                  <div class="upload-text">Selecciona una foto</div>
                </label>
              }
              <input
                #itemFileInput
                type="file"
                accept="image/*"
                (change)="onItemImageSelected($event)"
                class="hidden-input">
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Descripci√≥n *</label>
            <textarea
              [(ngModel)]="newItem.description"
              placeholder="Describe los ingredientes y caracter√≠sticas del plato"
              class="form-input form-textarea"
              rows="3"
              maxlength="200"></textarea>
            <span class="input-counter">{{ newItem.description.length }}/200</span>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Categor√≠a *</label>
              <select [(ngModel)]="newItem.category" class="form-input">
                <option value="bebidas">ü•§ Bebidas</option>
                <option value="rolls">üçú Rolls</option>
                <option value="nigiri">üç£ Nigiri</option>
                <option value="sashimi">üç± Sashimi</option>
                <option value="especiales">‚≠ê Especiales</option>
                <option value="postres">üç∞ Postres</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Precio *</label>
              <div class="price-input-wrapper">
                <span class="currency">$</span>
                <input
                  type="number"
                  [(ngModel)]="newItem.price"
                  placeholder="0.00"
                  class="form-input price-input"
                  min="0"
                  step="0.01">
              </div>
            </div>
          </div>

          <button class="btn-submit" (click)="addItem()">
            <span>‚úì</span> {{ isEditing ? 'Actualizar' : 'Guardar' }} Plato
          </button>
        </div>
      }

      @if (activeType === 'combos') {
        <div class="form">
          <div class="form-group">
            <label class="form-label">Nombre del combo *</label>
            <input
              type="text"
              [(ngModel)]="newCombo.name"
              (change)="onComboNameChange()"
              placeholder="Ej: Combo Familiar"
              class="form-input"
              maxlength="50">
            <span class="input-counter">{{ newCombo.name.length }}/50</span>
            @if (newCombo.japaneseName) {
              <span class="japanese-preview">{{ newCombo.japaneseName }}</span>
            }
          </div>
          <div class="form-group">
            <label class="form-label">Foto del combo</label>
            <div class="image-upload-wrapper">
              @if (comboImagePreview) {
                <div class="image-preview">
                  <img [src]="comboImagePreview" alt="Preview">
                  <button type="button" class="change-btn" (click)="comboFileInput.click()">Cambiar</button>
                </div>
              } @else {
                <label class="upload-area" (click)="comboFileInput.click()">
                  <div class="upload-icon">üì∏</div>
                  <div class="upload-text">Selecciona una foto</div>
                </label>
              }
              <input
                #comboFileInput
                type="file"
                accept="image/*"
                (change)="onComboImageSelected($event)"
                class="hidden-input">
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Selecciona platillos *</label>
            <div class="combo-items-list">
              @for (item of menuItems; track item.id) {
                <div class="combo-item">
                  <label class="combo-item-label">
                    <input
                      type="checkbox"
                      [checked]="selectedComboItems[item.id] || false"
                      (change)="toggleComboItem(item.id)"
                      class="combo-checkbox">
                    <div class="combo-item-info">
                      <div class="combo-item-name">{{ item.name }}</div>
                      <div class="combo-item-price">${{ item.price }}</div>
                    </div>
                  </label>
                </div>
              }
              @if (menuItems.length === 0) {
                <div class="empty-items">No hay platillos disponibles</div>
              }
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Descripci√≥n (opcional)</label>
            <textarea
              [(ngModel)]="newCombo.description"
              placeholder="Describe qu√© incluye el combo (se genera autom√°ticamente si dejas vac√≠o)"
              class="form-input form-textarea"
              rows="2"
              maxlength="200"></textarea>
            <span class="input-counter">{{ newCombo.description.length }}/200</span>
          </div>

          <div class="form-group">
            <label class="form-label">Precio *</label>
            <div class="combo-price-info">
              <div class="price-breakdown">
                <span class="original-price">Total: ${{ getSelectedComboPrice() }}</span>
                <span class="discount-badge">-10% descuento</span>
                <span class="final-price">Precio final: ${{ newCombo.price }}</span>
              </div>
            </div>
          </div>

          <button class="btn-submit" (click)="addItem()">
            <span>‚úì</span> {{ isEditing ? 'Actualizar' : 'Guardar' }} Combo
          </button>
        </div>
      }
    </div>
  </div>
</div>
